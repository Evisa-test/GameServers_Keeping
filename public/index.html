<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>续期管理面板</title>
  <link rel="stylesheet" href="/style.css">
</head>
<body>
  <div class="container">
    <header>
      <h1>续期管理面板</h1>
      <button id="logout-btn" onclick="location.href='/api/logout'">登出</button>
    </header>
    
    <div id="variables-list">
      <!-- Server items will be dynamically inserted here -->
    </div>
    <div class="footer-actions">
      <button id="add-variable" class="btn btn-primary">添加服务器</button>
      <button id="save-all" class="btn btn-save">保存所有更改</button>
      <button id="refresh-status" class="btn">刷新状态</button>
      <button id="trigger-all" class="btn btn-danger">立即触发所有续期</button>
    </div>
  </div>
  <template id="server-template">
    <div class="variable-item">
      <div class="variable-summary">
        <span class="server-name">新服务器</span>
        <div class="summary-actions">
          <span class="status-indicator"></span>
          <button class="btn-toggle-details">详情</button>
        </div>
      </div>
      <div class="variable-details" style="display: none;">
        <div class="form-grid">
          <div class="form-group">
            <label>服务器名称</label>
            <input type="text" data-key="name" placeholder="例如：我的主服务器 (可选)">
          </div>
          <div class="form-group">
            <label>服务器ID</label>
            <input type="text" data-key="serverId" placeholder="服务器的唯一标识">
          </div>
          <div class="form-group">
            <label>API Key</label>
            <input type="text" data-key="apiKey" placeholder="用于API认证的密钥">
          </div>
          <div class="form-group">
            <label>续期URL</label>
            <input type="text" data-key="renewUrl" placeholder="完整的续期请求地址">
          </div>
          <div class="form-group full-width">
            <label>续期时间 (HH:mm)</label>
            <div class="time-inputs">
              <!-- Time inputs will be added here -->
            </div>
            <button class="btn btn-add-time">添加时间</button>
          </div>
          <div class="form-group full-width">
            <label>续期日期</label>
            <div class="day-selector">
              <button class="day-btn" data-day="everyday">每天</button>
              <button class="day-btn" data-day="1">一</button>
              <button class="day-btn" data-day="2">二</button>
              <button class="day-btn" data-day="3">三</button>
              <button class="day-btn" data-day="4">四</button>
              <button class="day-btn" data-day="5">五</button>
              <button class="day-btn" data-day="6">六</button>
              <button class="day-btn" data-day="0">日</button>
            </div>
          </div>
        </div>
        <div class="actions">
          <button class="btn btn-delete">删除服务器</button>
        </div>
      </div>
    </div>
  </template>
  <script>
    document.addEventListener('DOMContentLoaded', () => {
      const variablesList = document.getElementById('variables-list');
      const addVariableBtn = document.getElementById('add-variable');
      const saveAllBtn = document.getElementById('save-all');
      const serverTemplate = document.getElementById('server-template');
      let servers = [];
      // Fetch initial data
      fetch('/api/variables')
        .then(response => {
          if (response.status === 401) {
            window.location.href = '/login.html';
            return;
          }
          return response.json();
        })
        .then(data => {
          if (data) {
            servers = data;
            render();
          }
        });
      function createServerElement(server, index) {
        const templateClone = serverTemplate.content.cloneNode(true);
        const serverElement = templateClone.querySelector('.variable-item');
        serverElement.dataset.index = index;
        const nameInput = serverElement.querySelector('[data-key="name"]');
        const serverIdInput = serverElement.querySelector('[data-key="serverId"]');
        const apiKeyInput = serverElement.querySelector('[data-key="apiKey"]');
        const renewUrlInput = serverElement.querySelector('[data-key="renewUrl"]');
        const serverName = serverElement.querySelector('.server-name');
        
        nameInput.value = server.name || '';
        serverIdInput.value = server.serverId || '';
        apiKeyInput.value = server.apiKey || '';
        renewUrlInput.value = server.renewUrl || '';
        serverName.textContent = server..name || '新服务器';
        const timeInputsContainer = serverElement.querySelector('.time-inputs');
        timeInputsContainer.innerHTML = '';
        (server.renewalTimes || []).forEach(time => {
          const timeGroup = createTimeInput(time);
          timeInputsContainer.appendChild(timeGroup);
        });
        const daySelector = serverElement.querySelector('.day-selector');
        const renewalDays = server.renewalDays || ['everyday'];
        
        daySelector.querySelectorAll('.day-btn').forEach(btn => {
          const day = btn.dataset.day;
          if (renewalDays.includes(day)) {
            btn.classList.add('active');
          }
          btn.addEventListener('click', () => {
            if (day === 'everyday') {
              btn.classList.toggle('active');
              const isActive = btn.classList.contains('active');
              daySelector.querySelectorAll('.day-btn').forEach(otherBtn => {
                if (otherBtn !== btn) otherBtn.classList.remove('active');
              });
              if (isActive) {
                servers[index].renewalDays = ['everyday'];
              } else {
                servers[index].renewalDays = [];
              }
            } else {
              daySelector.querySelector('[data-day="everyday"]').classList.remove('active');
              btn.classList.toggle('active');
              const activeDays = Array.from(daySelector.querySelectorAll('.day-btn.active'))
                                      .map(b => b.dataset.day)
                                      .filter(d => d !== 'everyday');
              servers[index].renewalDays = activeDays.length > 0 ? activeDays : ['everyday'];
               if (activeDays.length === 0) {
                 daySelector.querySelector('[data-day="everyday"]').classList.add('active');
               }
            }
          });
        });
        nameInput.addEventListener('input', () => {
          serverName.textContent = nameInput.value || '新服务器';
        });
        serverElement.querySelector('.btn-toggle-details').addEventListener('click', () => {
          const details = serverElement.querySelector('.variable-details');
          details.style.display = details.style.display === 'none' ? 'block' : 'none';
        });
        serverElement.querySelector('.btn-delete').addEventListener('click', () => {
          if (confirm(`确定要删除服务器 "${server.name || '新服务器'}" 吗?`)) {
            servers.splice(index, 1);
            render();
          }
        });
        serverElement.querySelector('.btn-add-time').addEventListener('click', (e) => {
          const container = e.target.previousElementSibling;
          container.appendChild(createTimeInput(''));
        });
        return serverElement;
      }
      function createTimeInput(time) {
        const div = document.createElement('div');
        div.className = 'time-input-group';
        const input = document.createElement('input');
        input.type = 'time';
        input.value = time;
        const deleteBtn = document.createElement('button');
        deleteBtn.className = 'btn-delete-time';
        deleteBtn.innerHTML = '&times;';
        deleteBtn.onclick = () => div.remove();
        div.appendChild(input);
        div.appendChild(deleteBtn);
        return div;
      }
      function render() {
        variablesList.innerHTML = '';
        servers.forEach((server, index) => {
          variablesList.appendChild(createServerElement(server, index));
        });
      }
      addVariableBtn.addEventListener('click', () => {
        servers.push({
          name: '',
          serverId: '',
          apiKey: '',
          renewUrl: '',
          renewalTimes: ['08:00'],
          renewalDays: ['everyday']
        });
        render();
        const newItem = variablesList.lastElementChild;
        const details = newItem.querySelector('.variable-details');
        details.style.display = 'block';
        newItem.querySelector('[data-key="name"]').focus();
      });
      saveAllBtn.addEventListener('click', () => {
        const updatedServers = [];
        variablesList.querySelectorAll('.variable-item').forEach((item, index) => {
          const serverData = servers[item.dataset.index];
          const updatedServer = {
            name: item.querySelector('[data-key="name"]').value,
            serverId: item.querySelector('[data-key="serverId"]').value,
            apiKey: item.querySelector('[data-key="apiKey"]').value,
            renewUrl: item.querySelector('[data-key="renewUrl"]').value,
            renewalTimes: Array.from(item.querySelectorAll('.time-input-group input')).map(input => input.value).filter(Boolean),
            renewalDays: serverData.renewalDays // This is updated directly on click
          };
          updatedServers.push(updatedServer);
        });
        servers = updatedServers;
        fetch('/api/variables', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify(servers)
        }).then(response => {
          if (response.ok) {
            alert('保存成功！');
            render(); // Re-render to reflect new indices and clean data
          } else {
            alert('保存失败。');
          }
        });
      });
        document.getElementById('refresh-status').addEventListener('click', () => {
            alert('刷新功能待实现');
        });
        document.getElementById('trigger-all').addEventListener('click', async () => {
            if (!confirm('确定要立即触发所有服务器的续期吗？此操作不可逆。')) {
                return;
            }
            try {
                const response = await fetch('/api/trigger', { method: 'POST' });
                if (response.ok) {
                    const result = await response.text();
                    alert('触发成功！\n' + result);
                } else {
                    const error = await response.text();
                    alert('触发失败：' + error);
                }
            } catch (err) {
                alert('请求失败：' + err.message);
            }
        });
    });
  </script>
</body>
</html>
